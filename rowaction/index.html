<!DOCTYPE html><html lang="cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 关于自定义 UITableViewRowAction</title><meta name="description" content="关于自定义 UITableViewRowAction - ooatuoo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://atuo.xyz/atom.xml" title="ooatuoo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ooatuoo" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/atuooo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">关于自定义 UITableViewRowAction</h1><div class="post-info">Feb 26, 2017</div><div class="post-content"><p>想必大家都比较熟悉 UITableView 的 RowAction 了，Apple 在 iOS 2.0 的时候就提供了相关的接口，当时只有 “Delete” 的选项，在 iOS 8.0 之后，增加了 <code>UITableViewRowAction</code> 以及相关的代理方法：<code>tableView(_:editActionsForRowAt:)</code>。但只是提供了改变 <code>tiltle</code> 和 <code>backgroundColor</code> 的接口，可自定义的空间很小。在如今强调交互的时代，越来越多的 App 开始在 RowAction 上做文章，连 Apple 官方的 Mail 都抛弃其原生的控件，重新实现了 RowAction 的效果，其交互方式也改进了一些。所以我们该如何去自定义 RowAction 呢？</p>
<a id="more"></a>
<h2 id="在原生控件上自定义"><a href="#在原生控件上自定义" class="headerlink" title="在原生控件上自定义"></a>在原生控件上自定义</h2><p>如果只是要修改下 <code>RowAction</code> 中 text 相关的属性，或者添加 icon 的话，可以用一些偏方来实现。比如可以通过修改 cell Button 的 Appearance 来改变 RA 中 Button 的样式：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> btnAppearance = <span class="type">UIButton</span>.appearance(whenContainedInInstancesOf:[<span class="type">TheCell</span>.<span class="keyword">self</span>])</div><div class="line"><span class="keyword">let</span> attString = <span class="type">NSAttributedString</span>(string: <span class="string">"Delete"</span>, attributes: textAttributes)</div><div class="line">btnAppearance.setAttributedTitle(attString, <span class="keyword">for</span>: .normal)</div></pre></td></tr></table></figure>
<p>但这个方法还是有一些据局限性，比如只适合 <em>有且仅有</em>一个 RowAction，并且 cell 中没有需要自定义 Button 的情况。</p>
<p>另一种方法是，通过 <code>patternImage</code> 来设置 RowAction 的  <code>backgroundColor</code>。我们可以将文字或 icon 按我们想要的样式、属性绘制成 <code>UIImage</code>，然后通过 <code>UIColor.init(patternImage:)</code> 来设置 <code>backgroundColor</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="type">UIGraphicsBeginImageContextWithOptions</span>(rowActionSize, <span class="literal">false</span>, <span class="type">UIScreen</span>.main.nativeScale)</div><div class="line"><span class="keyword">let</span> context = <span class="type">UIGraphicsGetCurrentContext</span>()!</div><div class="line"></div><div class="line">context.setFillColor(bgColor.cgColor)</div><div class="line">context.fill(<span class="type">CGRect</span>(origin: .zero, size: rowActionSize))</div><div class="line">icon.draw(<span class="keyword">in</span>: iconRect)</div><div class="line">title.draw(<span class="keyword">in</span>: titleRect, withAttributes: titleAttributes)</div><div class="line"> </div><div class="line"><span class="keyword">let</span> patternImage = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()!</div><div class="line"><span class="type">UIGraphicsEndImageContext</span>()</div><div class="line"></div><div class="line">backgroundColor = <span class="type">UIColor</span>(patternImage: patternImage)</div></pre></td></tr></table></figure>
<p>用这种方法时，需要根据 <code>RowAction</code> 最终的宽度来计算出需要用多少个空格符来组成字符串，给到 RowAction 的 <code>tiltle</code>。另外原生的 RowAction 的宽度是 title (默认的字体是 <code>(UIFont.systemFont(ofSize: 18)</code>) 的宽度加上两边的边距（padding = 15）。</p>
<p>具体的实现可以看我写的 <a href="https://github.com/atuooo/CustomSwipeCell" target="_blank" rel="external">demo</a>。</p>
<h2 id="自定义-RowAction"><a href="#自定义-RowAction" class="headerlink" title="自定义 RowAction"></a>自定义 RowAction</h2><p>如果想要实现左右滑，或者不满于 RowAction 的交互方式（比如，RowAction 在展开时，会屏蔽 UITableView 上所有的手势，当你想要上滑查看 tableView 上的内容时，RowAction 会截断，并收起 RowAction ，其实这给人感觉很不自然），我们可以自己去实现类似 RowAction 的效果。</p>
<p>其实思路还是比较简单的，主要是处理好自定义的 RowAction  收起和展开时的动效及其连贯性。这里我是将 cell 上要展示的所有内容放到一个新的 contentView 上，然后把这个 contentView 以及 所需的 RowActionButton 根据位置关系放到一个 scrollView 上。之所以用 UIScrollView，主要利用其  <code>setContentOffset(_: animated: )</code> 方法来达到类似原生收起展开的效果。具体的实现可以看我的 <a href="https://github.com/atuooo/CustomSwipeCell" target="_blank" rel="external">demo</a>。</p>
<p>这里主要想说下在交互上的一些处理：</p>
<ul>
<li>当 RowAction 在展开状态时，用户点击 tableView 上任何区域（包括该 cell），收起该 RowAction。</li>
<li>当用户滑动 tableView 时，不应该像原生那样截断手势，而是默认收起并滚动。</li>
<li>当某个 cell 的 RA 在展开状态时，用户去展开其他 cell，则应收起该 cell 并展开另一个 cell。</li>
</ul>
<p>上面的需求都可以通过 <code>Notification</code> 去实现。</p>
<p>另外因为我在 contentView 上添加一个 <code>panGesture</code> 用来展开 RowAction，所以需要处理下该手势和 UITableView 的滚动手势以及侧滑手势的冲突：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">gestureRecognizerShouldBegin</span><span class="params">(<span class="number">_</span> gestureRecognizer: UIGestureRecognizer)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">   <span class="keyword">if</span> <span class="keyword">let</span> ges = gestureRecognizer <span class="keyword">as</span>? <span class="type">UIPanGestureRecognizer</span>,</div><div class="line">      ges === panGesture &#123;</div><div class="line">      <span class="keyword">let</span> gesLocation = ges.location(<span class="keyword">in</span>: <span class="keyword">self</span>)</div><div class="line">      <span class="keyword">if</span> gesLocation.x &lt;= <span class="number">22</span> &#123;    <span class="comment">// 处理和侧滑手势的冲突</span></div><div class="line">         <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 处理和 tableView 滚动手势的冲突</span></div><div class="line">         <span class="keyword">let</span> translation = ges.translation(<span class="keyword">in</span>: superview)</div><div class="line">         <span class="keyword">return</span> fabs(translation.x) &gt; fabs(translation.y)</div><div class="line">      &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.gestureRecognizerShouldBegin(gestureRecognizer)</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最近有个国外的开发者开源了一个 <a href="https://github.com/jerkoch/SwipeCellKit" target="_blank" rel="external">SwipeCellKit</a> 的项目，其实现思路是，直接改变 cell 的位置，然后利用 iOS 10 推出的新的动画框架 <code>UIViewPropertyAnimator</code> 去实现滑动时的伸缩以及展开收起时的效果。开源的作者是参照 Mail 的 自定义 RowAction 去实现的，并扩展了一些样式的选择，其 API 设计的也很不错，感兴趣的可以看下。</p>
<p><img src="http://ogem1is2k.bkt.clouddn.com/static/images/rowaction/swipekit_demo.gif" alt="swipeCellKit_demo"></p>
</div></article></div></main><footer><div class="paginator"><a href="/unowned_weak/" class="next">NEXT</a></div><div data-thread-key="rowaction/" data-title="关于自定义 UITableViewRowAction" data-url="http://atuo.xyz/rowaction/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"ooatuoo"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2017 <a href="http://atuo.xyz">ooatuoo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">apollo_theme</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-67913126-2",'auto');ga('send','pageview');</script></body></html>