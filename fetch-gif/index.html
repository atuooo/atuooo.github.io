<!DOCTYPE html><html lang="cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 从相册中获取 GIF 的一些小 Tip</title><meta name="description" content="从相册中获取 GIF 的一些小 Tip - ooatuoo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://atuo.xyz/atom.xml" title="ooatuoo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ooatuoo" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/atuooo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">从相册中获取 GIF 的一些小 Tip</h1><div class="post-info">Nov 5, 2016</div><div class="post-content"><p>在 iOS 8 的时候，Apple 推出了 <a href="https://developer.apple.com/reference/photos" target="_blank" rel="external">PhotoKit</a> 框架，提供了一系列丰富的接口，想了解 PhotoKit 的同学，可以看下 Apple 的示例：<a href="https://developer.apple.com/library/content/samplecode/UsingPhotosFramework/Introduction/Intro.html#//apple_ref/doc/uid/TP40014575" target="_blank" rel="external">Example app using Photos framework</a>。</p>
<h3 id="如何判断-GIF-资源"><a href="#如何判断-GIF-资源" class="headerlink" title="如何判断 GIF 资源"></a>如何判断 GIF 资源</h3><h4 id="1-获取-PHAsset-的资源对象-PHAssetResource，通过其-uniformTypeIdentifier-或-originalFilename-属性来判断是否为-GIF："><a href="#1-获取-PHAsset-的资源对象-PHAssetResource，通过其-uniformTypeIdentifier-或-originalFilename-属性来判断是否为-GIF：" class="headerlink" title="1. 获取 PHAsset 的资源对象 PHAssetResource，通过其 uniformTypeIdentifier 或 originalFilename 属性来判断是否为 GIF："></a>1. 获取 <code>PHAsset</code> 的资源对象 <code>PHAssetResource</code>，通过其 <code>uniformTypeIdentifier</code> 或 <code>originalFilename</code> 属性来判断是否为 GIF：</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PHAsset</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> isGIF: <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">let</span> resource = <span class="type">PHAssetResource</span>.asssetResources(<span class="keyword">for</span>: <span class="keyword">self</span>).first!</div><div class="line">  	</div><div class="line">  	<span class="comment">// 通过统一类型标识符(uniform type identifier) UTI 来判断</span></div><div class="line">  	<span class="keyword">let</span> uti = resource.uniformTypeIdentifier <span class="keyword">as</span> <span class="type">CFString</span></div><div class="line">	<span class="keyword">return</span> <span class="type">UTTypeConformsTo</span>(uti, kUTTypeGIF) </div><div class="line">	</div><div class="line">	<span class="comment">// 或者通过文件名后缀来判断</span></div><div class="line">	<span class="keyword">return</span> assetSource.originalFilename.hasSuffix(<span class="string">"GIF"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于<code>PHAssetResource</code>，每个 PHAsset 对象都会引用一个或多个资源（resource），一个被修改过的图片的<code>PHAsset</code> 对象会包含图片编辑之前和之后的 resource，以及关于描述这次编辑的<code>PHAdjustmentData</code>对象的 resource。我们可以将一个修改过后的 GIF 的 <code>PHAsset</code> 所包含的 <code>PHAssetResource</code> 打印出来看下：</p>
<a id="more"></a>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> resources = <span class="type">PHAssetResource</span>.assetResources(<span class="keyword">for</span>: asset)</div><div class="line">resources.<span class="built_in">map</span> &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;</div><div class="line"></div><div class="line"><span class="comment">/* 输出：</span></div><div class="line">修改之前：</div><div class="line">&lt;PHInternalAssetResource: 0x6000002e0f80&gt; type=photo size=&#123;636, 400&#125; fileSize=668682 uti=com.compuserve.gif filename=IMG_0006.GIF assetLocalIdentifier=46ACADB2-357B-44B6-8837-4F686D2092BF/L0/001</div><div class="line"></div><div class="line">修改之后：</div><div class="line">&lt;PHInternalAssetResource: 0x6080000f2d80&gt; type=photo size=&#123;636, 400&#125; fileSize=668682 uti=public.jpeg filename=IMG_0006.GIF assetLocalIdentifier=46ACADB2-357B-44B6-8837-4F686D2092BF/L0/001</div><div class="line">&lt;PHInternalAssetResource: 0x6080000f3200&gt; type=photo_full size=&#123;636, 400&#125; fileSize=15481 uti=public.jpeg filename=FullSizeRender.jpg assetLocalIdentifier=46ACADB2-357B-44B6-8837-4F686D2092BF/L0/001</div><div class="line">&lt;PHInternalAssetResource: 0x6000000f2e80&gt; type=adjustment size=&#123;0, 0&#125; fileSize=776 uti=com.apple.property-list filename=Adjustments.plist assetLocalIdentifier=46ACADB2-357B-44B6-8837-4F686D2092BF/L0/001</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>从打印出的信息可以看到，在 GIF 被修改之后，UTI 从<code>com.compuserve.gif</code>变成了 <code>public.jpeg</code> ，所以这里如果还通过 UTI 来判断的话，就会错漏，只能通过 fileName 来判断。</p>
<p>另外， <code>PHAssetResource</code> 类只支持 iOS 9.0+。</p>
<h4 id="2-通过获取-PHAsset-的元数据来判断："><a href="#2-通过获取-PHAsset-的元数据来判断：" class="headerlink" title="2. 通过获取 PHAsset 的元数据来判断："></a>2. 通过获取 <code>PHAsset</code> 的元数据来判断：</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> requestOption = <span class="type">PHImageRequestOptions</span>()</div><div class="line">requestOption.version = .unadjusted</div><div class="line">requestOption.isSynchronous = <span class="literal">false</span></div><div class="line"></div><div class="line"><span class="type">PHImageManager</span>.<span class="keyword">default</span>().requestImageData(<span class="keyword">for</span>: asset,</div><div class="line">                                          options: requestOption,</div><div class="line">                                          resultHandler: &#123; (data, uti, orientation, info) <span class="keyword">in</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">let</span> <span class="type">UTI</span> = uti, <span class="type">UTTypeConformsTo</span>(<span class="type">UTI</span> <span class="keyword">as</span> <span class="type">CFString</span>, kUTTypeGIF) &#123;</div><div class="line">		<span class="comment">// It's GIF</span></div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>同样，这里也需要考虑到 GIF 被修改的情况，<code>requestOption.version</code> 默认是 <code>current</code> ，即如果图片被修改过的话，返回的就是包含所有调整和修改的图像数据，因此我们需要将其设置为 <code>unadjusted</code> 来获取原始的图像数据。</p>
<p>相比上面的方法，这种方法更快速，用时更少。</p>
<h3 id="关于-localIdentifier"><a href="#关于-localIdentifier" class="headerlink" title="关于 localIdentifier"></a>关于 localIdentifier</h3><p><code>localIdentifier</code> 是 <code>PHAsset</code> 的父类 <code>PHObject</code> 的一个属性，是每个图片资源独有的标识符。</p>
<p>我在开发 <a href="https://github.com/atuooo/notGIF" target="_blank" rel="external">notGIF</a> 的时候，每次启动时都需要遍历相册中的所有图片来获取其中的 GIF，这个操作非常的耗时，十分影响用户体验。我尝试过将其拆分成多个任务，分发到多个线程同时进行，虽然有些效果，但还是不尽如人意，毕竟随着相册中照片数量的增加，其所消耗的时间是线性增长的。</p>
<p>这时候，<code>localIdentifier</code> 就有了用武之地。因为 <code>localIdentifier</code> 是识别图片资源的唯一标识符，所以，我们可以在第一次获取到相册中的 GIF 的时候，将其获取到的所有 GIF 的 <code>localIdentifier</code> 记录下来。这样，下次启动的时候，就可以通过这些 <code>localIdentifier</code> 来直接获取 GIF 资源：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> gifAssets = <span class="type">PHAsset</span>.fetchAssets(withLocalIdentifiers: gifIDs, options: fetchOptions)</div></pre></td></tr></table></figure>
<p>如果 <code>localIdentifier</code> 所对应的图片资源被删除或不存在的话，<code>PHAsset.fetchAssets(withLocalIdentifiers: options:)</code> 会自动过滤掉。同时，我们可以在后台去检测相册是否有变化，如果有，则更新 UI 以及 所存储的 <code>localIdentifier</code> 的信息。</p>
<h3 id="获取相册中图片的-url"><a href="#获取相册中图片的-url" class="headerlink" title="获取相册中图片的 url"></a>获取相册中图片的 url</h3><p>在适配 iMessage Extension 的时候，需要通过图片的 url 来获取和发送图片，PhotoKit 也提供了获取图片资源 url 的方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">asset.requestContentEditingInput(with: requestOptions,</div><div class="line">                                 completionHandler: &#123; (editingInput, info) <span class="keyword">in</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">let</span> input = editingInput, <span class="keyword">let</span> picURL = input.fullSizeImageURL &#123;</div><div class="line">		<span class="comment">// insert attachment</span></div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/unowned_weak/" class="prev">PREV</a><a href="/view_pg/" class="next">NEXT</a></div><div data-thread-key="fetch-gif/" data-title="从相册中获取 GIF 的一些小 Tip" data-url="http://atuo.xyz/fetch-gif/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"ooatuoo"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="http://atuo.xyz">ooatuoo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">apollo_theme</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-67913126-2",'auto');ga('send','pageview');</script></body></html>